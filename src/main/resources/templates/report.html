<!DOCTYPE html>
<html lang="en" class="scroll-smooth" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragment::head}"></head>
<body class="bg-gray-50 text-gray-900 font-sans antialiased">

<header th:replace="~{fragment::header}"></header>

<main class="min-h-screen pt-32 pb-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">

        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Inquiries Report</h1>
                <p class="text-gray-500 mt-2 text-sm">Manage and track incoming messages.</p>
            </div>

            <div class="bg-white pl-4 pr-6 py-2 rounded-full shadow-sm border border-gray-200 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                    </svg>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Total Messages</span>
                    <span class="text-lg font-bold text-gray-900 leading-none" th:text="${#lists.size(contactMessages)}">0</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-t-2xl border-b border-gray-100 p-5 shadow-lg shadow-gray-200/50 flex flex-col sm:flex-row justify-between items-center gap-4">

            <div class="flex items-center gap-2 text-sm text-gray-600">
                <span>Show</span>
                <select id="rowsPerPage" onchange="changePageSize()" class="bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-16 p-2 cursor-pointer">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <span>entries</span>
            </div>

            <div class="relative w-full sm:w-72">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                    </svg>
                </div>
                <input type="text" id="searchInput" onkeyup="filterTable()" class="block w-full p-2.5 pl-10 text-sm text-gray-900 border border-gray-200 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 transition-all placeholder-gray-400" placeholder="Search name, email, service...">
            </div>
        </div>

        <div class="bg-white shadow-xl shadow-gray-200/50 rounded-b-2xl overflow-hidden border border-t-0 border-gray-100">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100" id="reportTable">
                    <thead class="bg-gray-50/80 backdrop-blur">
                    <tr>
                        <th onclick="sortTable(0)" scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 group select-none">
                            <div class="flex items-center gap-2">
                                Sender Details
                                <svg class="w-3 h-3 text-gray-300 group-hover:text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16l-6-6h12l-6 6z"/></svg>
                            </div>
                        </th>
                        <th onclick="sortTable(1)" scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 group select-none">
                            <div class="flex items-center gap-2">
                                Interest
                                <svg class="w-3 h-3 text-gray-300 group-hover:text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16l-6-6h12l-6 6z"/></svg>
                            </div>
                        </th>
                        <th onclick="sortTable(2)" scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 group select-none">
                            <div class="flex items-center gap-2">
                                Date
                                <svg class="w-3 h-3 text-gray-300 group-hover:text-indigo-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16l-6-6h12l-6 6z"/></svg>
                            </div>
                        </th>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider hidden sm:table-cell">Preview</th>
                        <th scope="col" class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100" id="tableBody">
                    <tr th:each="msg : ${contactMessages}" class="group hover:bg-indigo-50/30 transition-colors duration-200">

                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm shadow-md"
                                         th:text="${#strings.substring(msg.name,0,1)}">A</div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-bold text-gray-900" th:text="${msg.name}">Name</div> <div class="text-sm text-gray-500" th:text="${msg.email}">email@example.com</div>
                                    <div class="text-xs text-indigo-500 font-medium mt-0.5" th:if="${msg.phone != null}">
                                        <span class="text-gray-400 font-normal">Ph:</span> <span th:text="${msg.phone}"></span>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100 shadow-sm"
                                      th:text="${msg.service != null ? msg.service : 'General Inquiry'}">
                                    Service
                                </span>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:data-timestamp="${msg.createdAt}">
                            <div class="flex flex-col">
                                <span class="font-medium text-gray-700" th:text="${#temporals.format(msg.createdAt, 'MMM dd, yyyy')}">Jan 01</span>
                                <span class="text-xs text-gray-400" th:text="${#temporals.format(msg.createdAt, 'hh:mm a')}">10:00 AM</span>
                            </div>
                        </td>

                        <td class="px-6 py-4 hidden sm:table-cell">
                            <div class="text-sm text-gray-500 max-w-xs truncate" th:text="${msg.message}">
                                Message...
                            </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-2">
                                <button
                                        th:data-name="${msg.name}"
                                        th:data-email="${msg.email}"
                                        th:data-phone="${msg.phone}"
                                        th:data-service="${msg.service}"
                                        th:data-message="${msg.message}"
                                        th:data-date="${#temporals.format(msg.createdAt, 'dd MMM yyyy, HH:mm')}"
                                        onclick="openReportModal(this)"
                                        class="text-indigo-600 hover:text-white hover:bg-indigo-600 bg-indigo-50 p-2 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
                                        title="View Details">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>

                                <a th:href="@{/report/delete/{id}(id=${msg.id})}"
                                   onclick="return confirm('Are you sure you want to delete this message?')"
                                   class="text-red-500 hover:text-white hover:bg-red-500 bg-red-50 p-2 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
                                   title="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </a>
                            </div>
                        </td>
                    </tr>

                    <tr id="noResultsRow" class="hidden">
                        <td colspan="5" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center justify-center">
                                <div class="bg-gray-100 p-3 rounded-full mb-3">
                                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <p class="text-gray-500 font-medium text-sm">No matching records found.</p>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-4">
                <span class="text-sm text-gray-700">
                    Showing <span id="startRow" class="font-bold text-gray-900">1</span> to <span id="endRow" class="font-bold text-gray-900">10</span> of <span id="totalRows" class="font-bold text-gray-900">0</span> entries
                </span>
                <div class="inline-flex rounded-md shadow-sm">
                    <button onclick="prevPage()" id="prevBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 border-l-0 rounded-r-lg hover:bg-gray-100 hover:text-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="reportModal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true" onclick="closeReportModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                                <h3 class="text-xl leading-6 font-bold text-gray-900" id="modalService">Service</h3>
                                <span class="text-xs font-semibold text-gray-500 bg-gray-100 px-3 py-1 rounded-full" id="modalDate">Date</span>
                            </div>
                            <div class="space-y-5">
                                <div class="grid grid-cols-1 gap-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between">
                                        <div><label class="block text-xs font-bold text-gray-400 uppercase">From</label><div class="text-sm font-semibold text-gray-900 mt-1" id="modalName"></div></div>
                                        <div class="text-right"><label class="block text-xs font-bold text-gray-400 uppercase">Phone</label><div class="text-sm font-mono text-gray-700 mt-1" id="modalPhone"></div></div>
                                    </div>
                                    <div><label class="block text-xs font-bold text-gray-400 uppercase">Email</label><div class="text-sm text-indigo-600 font-medium mt-1" id="modalEmail"></div></div>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Message</label><div class="text-sm text-gray-600 bg-white p-4 rounded-xl border border-gray-200 shadow-sm whitespace-pre-wrap max-h-48 overflow-y-auto" id="modalMessage"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                    <a id="modalReplyBtn" href="#" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:w-auto sm:text-sm">Reply</a>
                    <button type="button" onclick="closeReportModal()" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Close</button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragment :: footer}"></footer>
<div th:replace="~{fragment :: js}"></div>

<script>
    // 1. Force Header Dark Grey
    document.addEventListener("DOMContentLoaded", function() {
        const header = document.getElementById('main-header');
        if(header) { header.classList.remove('bg-transparent'); header.classList.add('bg-gray-900', 'shadow-md'); }

        // Initialize Table
        initTable();
    });

    // --- VARIABLES ---
    let originalRows = []; // Store original DOM elements
    let filteredRows = []; // Rows matching search
    let currentPage = 1;
    let rowsPerPage = 10;
    let sortDirection = 1; // 1 = asc, -1 = desc

    function initTable() {
        const tbody = document.getElementById('tableBody');
        const rows = Array.from(tbody.querySelectorAll('tr:not(#noResultsRow)'));
        originalRows = rows;
        filteredRows = rows;
        updateTableDisplay();
    }

    // --- SEARCH FUNCTION ---
    function filterTable() {
        const input = document.getElementById('searchInput').value.toLowerCase();

        if (input === '') {
            filteredRows = originalRows;
        } else {
            filteredRows = originalRows.filter(row => {
                // Search in Name (cell 0), Service (cell 1), Date (cell 2), Message (hidden cell)
                return row.innerText.toLowerCase().includes(input);
            });
        }
        currentPage = 1; // Reset to page 1 on search
        updateTableDisplay();
    }

    // --- SORT FUNCTION ---
    function sortTable(columnIndex) {
        sortDirection *= -1; // Toggle direction

        filteredRows.sort((a, b) => {
            let valA, valB;

            // Special handling for Date column (Index 2)
            if(columnIndex === 2) {
                // Use data attribute for accurate date sorting
                valA = a.children[2].getAttribute('data-timestamp') || '';
                valB = b.children[2].getAttribute('data-timestamp') || '';
            } else {
                valA = a.children[columnIndex].innerText.trim().toLowerCase();
                valB = b.children[columnIndex].innerText.trim().toLowerCase();
            }

            if (valA < valB) return -1 * sortDirection;
            if (valA > valB) return 1 * sortDirection;
            return 0;
        });

        updateTableDisplay();
    }

    // --- PAGINATION LOGIC ---
    function changePageSize() {
        rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
        currentPage = 1;
        updateTableDisplay();
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTableDisplay();
        }
    }

    function nextPage() {
        const maxPage = Math.ceil(filteredRows.length / rowsPerPage);
        if (currentPage < maxPage) {
            currentPage++;
            updateTableDisplay();
        }
    }

    // --- CORE RENDER FUNCTION ---
    function updateTableDisplay() {
        const tbody = document.getElementById('tableBody');
        const noResults = document.getElementById('noResultsRow');
        const startSpan = document.getElementById('startRow');
        const endSpan = document.getElementById('endRow');
        const totalSpan = document.getElementById('totalRows');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        // Clear current body (except no results row)
        tbody.innerHTML = '';
        tbody.appendChild(noResults);

        const totalItems = filteredRows.length;

        if (totalItems === 0) {
            noResults.classList.remove('hidden');
            startSpan.innerText = 0;
            endSpan.innerText = 0;
            totalSpan.innerText = 0;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        } else {
            noResults.classList.add('hidden');
        }

        // Calculate pagination bounds
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, totalItems);

        // Append visible rows
        const visibleRows = filteredRows.slice(startIndex, endIndex);
        visibleRows.forEach(row => tbody.appendChild(row));

        // Update Footer Info
        startSpan.innerText = startIndex + 1;
        endSpan.innerText = endIndex;
        totalSpan.innerText = totalItems;

        // Update Buttons
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === Math.ceil(totalItems / rowsPerPage);
    }

    // --- MODAL FUNCTIONS (Same as before) ---
    function openReportModal(btn) {
        document.getElementById('modalService').textContent = btn.getAttribute('data-service') || 'Inquiry';
        document.getElementById('modalName').textContent = btn.getAttribute('data-name');
        document.getElementById('modalEmail').textContent = btn.getAttribute('data-email');
        document.getElementById('modalPhone').textContent = btn.getAttribute('data-phone') || 'N/A';
        document.getElementById('modalDate').textContent = btn.getAttribute('data-date');
        document.getElementById('modalMessage').textContent = btn.getAttribute('data-message');
        document.getElementById('modalReplyBtn').href = 'mailto:' + btn.getAttribute('data-email');
        document.getElementById('reportModal').classList.remove('hidden');
    }
    function closeReportModal() { document.getElementById('reportModal').classList.add('hidden'); }
    document.addEventListener('keydown', e => { if (e.key === "Escape") closeReportModal(); });
</script>

</body>
</html>